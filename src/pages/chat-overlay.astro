---
// src/pages/chat-overlay.astro
export const prerender = false;
---
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>void14|chat overlay</title>
    <style is:global>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;800&display=swap');

        html, body {
            margin: 0; padding: 0;
            background: transparent !important;
            overflow: hidden;
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
        }

        #chat-log {
            position: absolute;
            bottom: 30px; left: 0; right: 0;
            display: flex;
            flex-direction: column-reverse; 
            gap: 12px;
            list-style: none;
            padding: 0 30px;
            margin: 0;
        }

        .message-pill {
            display: flex;
            align-items: center;
            background: rgba(18, 18, 18, 0.85);
            backdrop-filter: blur(8px);
            padding: 12px 20px;
            border-radius: 12px;
            width: calc(100% - 40px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.1);
            animation: nuttySlide 0.4s cubic-bezier(0.18, 0.89, 0.32, 1.28) forwards;
        }

        /* Event Styles */
        .event-pill {
            background: linear-gradient(90deg, rgba(145, 71, 255, 0.9), rgba(18, 18, 18, 0.9));
            border: 1px solid rgba(145, 71, 255, 0.5);
        }
        .announcement-pill {
            background: rgba(43, 203, 186, 0.2);
            border: 2px solid #2bcbba;
        }
        /* Redeem Style */
        .redeem-pill {
            background: linear-gradient(90deg, rgba(255, 215, 0, 0.2), rgba(18, 18, 18, 0.9));
            border: 2px solid #ffd700;
        }

        .badges-container {
            display: inline-flex;
            gap: 6px;
            margin-right: 12px;
            align-items: center;
            flex-shrink: 0;
        }

        .badge-icon { width: 18px; height: 18px; object-fit: contain; }
        .user-name { font-weight: 800; font-size: 1rem; margin-right: 6px; }
        .separator { color: #ffffff; opacity: 0.4; margin-right: 10px; font-weight: 700; }
        .message-text { color: #ffffff; font-size: 1.05rem; line-height: 1.4; flex-grow: 1; }
        .event-text { font-weight: 800; text-transform: uppercase; letter-spacing: 1px; color: #fff; }

        @keyframes nuttySlide {
            from { opacity: 0; transform: translateY(20px) scale(0.95); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }

        .fade-out { animation: fadeAway 0.5s ease-in forwards; }
        @keyframes fadeAway { to { opacity: 0; transform: translateX(40px); filter: blur(8px); } }
    </style>
</head>
<body>
    <ul id="chat-log"></ul>

    <script>
        import tmi from 'tmi.js';

        const chatLog = document.getElementById('chat-log');
        const params = new URLSearchParams(window.location.search);
        const channel = (params.get('channel') || 'pointlessbish').toLowerCase();

        const BADGE_BASE = "https://static-cdn.jtvnw.net/badges/v1";
        const GLOBAL_BADGES = {
            'broadcaster': `https://static-cdn.jtvnw.net/badges/v1/5527c58c-fb7d-422d-b71b-f309dcb85cc1/1`,
            'moderator':   `${BADGE_BASE}/3267646d-33f0-4b17-b3df-f923a41db1d0/1`,
            'vip':         `${BADGE_BASE}/b817aba4-fad8-49e2-b88a-7cc744dfa6ec/1`,
            'subscriber':  `${BADGE_BASE}/5d9f2208-5dd8-11e7-8513-2ff4adfae661/1`, 
        };

        function createPill(content, customClass = '') {
            const li = document.createElement('li');
            li.className = `message-pill ${customClass}`;
            li.innerHTML = content;
            chatLog.prepend(li);
            setTimeout(() => {
                li.classList.add('fade-out');
                setTimeout(() => li.remove(), 550);
            }, 20000);
        }

        function getBadgesHTML(badges, username) {
            let html = '<div class="badges-container">';
            if (username === channel) html += `<img src="${GLOBAL_BADGES['broadcaster']}" class="badge-icon">`;
            if (badges) {
                Object.keys(badges).forEach(type => {
                    if (type === 'broadcaster' && username === channel) return;
                    const url = GLOBAL_BADGES[type];
                    if (url) html += `<img src="${url}" class="badge-icon">`;
                });
            }
            html += '</div>';
            return html === '<div class="badges-container"></div>' ? '' : html;
        }

        const client = new tmi.Client({
            connection: { secure: true, reconnect: true },
            channels: [channel]
        });

        // 1. MESSAGES, ANNOUNCEMENTS, & REDEEMS (with text)
        client.on('message', (chan, tags, message, self) => {
            if (self) return;
            
            // Check for Reward ID (Channel Points)
            const isRedeem = tags['custom-reward-id'] !== undefined;
            const isAnnouncement = tags['msg-id'] === 'announcement';
            
            const color = tags.color || '#00ffff';
            const badges = getBadgesHTML(tags.badges, tags.username);

            let content = `
                ${badges}
                <span class="user-name" style="color: ${color}">${tags['display-name']}</span>
                <span class="separator">:</span>
                <span class="message-text">${message}</span>
            `;

            if (isRedeem) {
                createPill(content, 'redeem-pill');
            } else if (isAnnouncement) {
                createPill(content, 'announcement-pill');
            } else {
                createPill(content);
            }
        });

        // 2. SUBS & GIFTS
        client.on('subscription', (chan, username) => {
            createPill(`<span class="event-text">üíú NEW SUB: ${username} joined!</span>`, 'event-pill');
        });

        client.on('resub', (chan, username, months) => {
            createPill(`<span class="event-text">üíú RESUB: ${username} for ${months} months!</span>`, 'event-pill');
        });

        client.on('subgift', (chan, gifter, recipient) => {
            createPill(`<span class="event-text">üéÅ ${gifter} gifted a sub to ${recipient}!</span>`, 'event-pill');
        });

        // 3. RAIDS
        client.on('raided', (chan, username, viewers) => {
            createPill(`<span class="event-text">‚öîÔ∏è RAID: ${username} brought ${viewers} viewers!</span>`, 'event-pill');
        });

        // 4. BITS
        client.on('cheer', (chan, tags, message) => {
            createPill(`<span class="event-text">üíé ${tags.username} cheered ${tags.bits} bits!</span>`, 'event-pill');
        });

        client.connect();
    </script>
</body>
</html>