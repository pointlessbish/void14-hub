---
import ChatOverlay from '../../components/ChatOverlay.astro';

export const prerender = false;
const { channel } = Astro.params;

// Safety check to prevent server-side crashes
if (!channel) return Astro.redirect('/chat-overlay?channel=');
---

<ChatOverlay title={`VOID14 UPLINK | ${channel}`}>
    <ul id="chat-log"></ul>
    
    <script is:inline define:vars={{ channel }}>
        const channelID = channel.toLowerCase();
        let client = null;

        async function initChat() {
            // Check if the script tag actually loaded the library
            if (typeof window.tmi === 'undefined') {
                console.warn("VOID_OS: SIGNAL_INTERRUPTED... RETRYING_UPLINK");
                return;
            }

            if (client) return; // Prevent double-connecting

            try {
                client = new window.tmi.Client({
                    connection: { secure: true, reconnect: true },
                    channels: [channelID]
                });

                client.on('message', (chan, tags, message, self) => {
                    if (self) return;
                    const chatLog = document.getElementById('chat-log');
                    const userColor = tags.color || '#00f2ff';
                    const li = document.createElement('li');
                    li.className = 'message-pill';
                    li.style.setProperty('--user-color', userColor);
                    li.innerHTML = `
                        <div class="message-content">
                            <span class="user-name" style="color: ${userColor}">${tags['display-name']}</span>
                            <span class="message-text">${message}</span>
                        </div>
                    `;
                    chatLog.appendChild(li);
                    if (chatLog.children.length > 15) chatLog.firstElementChild.remove();
                    window.scrollTo(0, document.body.scrollHeight);
                });

                await client.connect();
                console.log("%c UPLINK_STABLE ", 'background: #00f2ff; color: #000');
                
                // Connection successful: Kill the retry loop
                if (window.uplinkInterval) clearInterval(window.uplinkInterval);
            } catch (err) {
                console.error("VOID_OS: UPLINK_CRITICAL_FAILURE", err);
            }
        }

        initChat();

        // Retry loop that only runs if the library isn't found yet
        window.uplinkInterval = setInterval(() => {
            if (typeof window.tmi !== 'undefined' && !client) {
                initChat();
            }
        }, 1000);
    </script>
</ChatOverlay>

<style>
    #chat-log {
        position: fixed;
        bottom: 30px;
        left: 30px;
        width: 420px;
        margin: 0;
        padding: 0;
        list-style: none;
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    :global(.user-name) {
        font-family: 'Inter', sans-serif;
        font-weight: 900;
        font-size: 0.85rem;
        text-transform: uppercase;
        display: block;
        margin-bottom: 4px;
    }

    :global(.message-text) {
        font-family: 'Inter', sans-serif;
        color: #ffffff;
        font-size: 1rem;
        line-height: 1.4;
    }
</style>